#include <openssl/sha.h>
#include <string.h>
#include <sha256.h>

uint8_t pad_sha2_256_768[32] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0x0};
uint8_t pad_sha2_256_1024[64] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x4, 0x0};
uint8_t pad_sha2_256_416[12] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xa0};
uint8_t pad_sha2_256_608[52] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x60};
uint8_t pad_sha2_256_480[68] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xe0};
uint8_t pad_sha2_256_440[9] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xb8};
uint8_t pad_sha2_256_432[10] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xb0};
uint8_t pad_sha2_256_688[42] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0xb0};
uint8_t pad_sha2_256_376[17] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x78};
uint8_t pad_sha2_256_368[18] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x70};
uint8_t pad_sha2_256_560[58] = {0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x30};

uint8_t *paddings[LENGTH_COUNT] = {
    pad_sha2_256_768,
    pad_sha2_256_1024,
    pad_sha2_256_416,
    pad_sha2_256_608,
    pad_sha2_256_480,
    pad_sha2_256_440,
    pad_sha2_256_432,
    pad_sha2_256_688,
    pad_sha2_256_376,
    pad_sha2_256_368,
    pad_sha2_256_560};

uint32_t input_length[LENGTH_COUNT] = {
    96,
    128,
    52,
    76,
    60,
    55,
    54,
    86,
    47,
    46,
    70};

uint32_t padding_length[LENGTH_COUNT] = {
    sizeof(pad_sha2_256_768),
    sizeof(pad_sha2_256_1024),
    sizeof(pad_sha2_256_416),
    sizeof(pad_sha2_256_608),
    sizeof(pad_sha2_256_480),
    sizeof(pad_sha2_256_440),
    sizeof(pad_sha2_256_432),
    sizeof(pad_sha2_256_688),
    sizeof(pad_sha2_256_376),
    sizeof(pad_sha2_256_368),
    sizeof(pad_sha2_256_560)};

// Snippet taken from OpenSSL include/crypto/md32_common.h
#define HOST_c2l(c, l) (l = (((unsigned long)(*((c)++))) << 24),  \
                        l |= (((unsigned long)(*((c)++))) << 16), \
                        l |= (((unsigned long)(*((c)++))) << 8),  \
                        l |= (((unsigned long)(*((c)++)))))
#define HOST_l2c(l, c) (*((c)++) = (unsigned char)(((l) >> 24) & 0xff), \
                        *((c)++) = (unsigned char)(((l) >> 16) & 0xff), \
                        *((c)++) = (unsigned char)(((l) >> 8) & 0xff),  \
                        *((c)++) = (unsigned char)(((l)) & 0xff),       \
                        l)

// Snippet taken from OpenSSL crypto/sha/sha256.c
#define HASH_MAKE_STRING(c, s)                            \
    do                                                    \
    {                                                     \
        unsigned long ll;                                 \
        unsigned int nn;                                  \
        for (nn = 0; nn < SHA256_DIGEST_LENGTH / 4; nn++) \
        {                                                 \
            ll = (c)->h[nn];                              \
            (void)HOST_l2c(ll, (s));                      \
        }                                                 \
    } while (0)

void hash_make_string(SHA256_CTX *ctx, unsigned char *out)
{
    HASH_MAKE_STRING(ctx, out);
}

void sha2_256_no_padding(const unsigned char *in, unsigned int in_len, unsigned char *out)
{
    SHA256_CTX ctx;

    SHA256_Init(&ctx);
    SHA256_Update(&ctx, in, in_len);

    hash_make_string(&ctx, out);
}

void sha2_256_length(enum length l, const unsigned char *in, unsigned char *out)
{
    int hash_in_len = input_length[l] + padding_length[l];
    char hash_in[hash_in_len];
    memcpy(hash_in, in, input_length[l]);
    memcpy(hash_in + input_length[l], paddings[l], padding_length[l]);

    sha2_256_no_padding(hash_in, hash_in_len, out);
}

void sha2_256_custom_padding_no_copy(unsigned char *in, unsigned int inlen, unsigned char *out)
{
    int block_count = (inlen / 64) + 1;
    if (inlen % 64 > 55)
    {
        block_count++;
    }
    int hash_in_len = block_count * 64;

    in[inlen] = 0x80;

    memset(in + inlen + 1, 0x00, (hash_in_len - inlen - 1));

    int inlen_bits = inlen * 8;
    unsigned char *ptr = in + hash_in_len - 1;
    while (inlen_bits > 0)
    {
        *ptr = inlen_bits & 0xFF;
        ptr--;
        inlen_bits = inlen_bits >> 8;
    }

    sha2_256_no_padding(in, hash_in_len, out);
}
void sha2_256_custom_padding(const unsigned char *in, unsigned int inlen, unsigned char *out)
{
    int block_count = (inlen / 64) + 1;
    if (inlen % 64 > 55)
    {
        block_count++;
    }

    int hash_in_len = block_count * 64;
    unsigned char hash_in[hash_in_len];

    memcpy(hash_in, in, inlen);
    hash_in[inlen] = 0x80;

    memset(hash_in + inlen + 1, 0x00, (hash_in_len - inlen - 1));

    int inlen_bits = inlen * 8;
    unsigned char *ptr = hash_in + hash_in_len - 1;
    while (inlen_bits > 0)
    {
        *ptr = inlen_bits & 0xFF;
        ptr--;
        inlen_bits = inlen_bits >> 8;
    }

    sha2_256_no_padding(hash_in, hash_in_len, out);
}